<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Operator Insertion Game</title>

<style>
body {
    background: #0f172a;
    color: white;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 40px;
}

h1 { color: #22c55e; }

#level {
    font-size: 1.2em;
    margin-bottom: 10px;
}

button {
    padding: 10px 22px;
    font-size: 1em;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    background: #22c55e;
    cursor: pointer;
    margin: 5px;
}

button:hover { background: #16a34a; }

/* ✅ FIXED EXPRESSION CONTAINER */
#expression {
    display: flex;
    gap: 8px;
    margin: 20px 0;
    font-size: 1.4em;
    align-items: center;

    max-width: 100%;
    overflow-x: auto;
    padding: 10px 5px;
    scrollbar-width: thin;
}

/* prevent shrinking on mobile */
#expression > div {
    flex-shrink: 0;
}

/* scrollbar styling */
#expression::-webkit-scrollbar {
    height: 6px;
}
#expression::-webkit-scrollbar-thumb {
    background: #22c55e;
    border-radius: 6px;
}

/* ✅ MOBILE-FRIENDLY SLOT */
.slot {
    width: 42px;
    height: 42px;
    min-width: 42px;
    border: 2px dashed #64748b;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.2em;
}

.locked {
    background: #14532d;
    border-color: #22c55e;
}

#target {
    font-size: 1.3em;
    margin-top: 10px;
}

#hint {
    margin-top: 8px;
    color: #facc15;
}

#message {
    margin-top: 15px;
    min-height: 24px;
}
</style>
</head>

<body>

<h1>Insert the Operators</h1>

<div id="level">Level 1</div>
<button onclick="startGame()">START</button>

<div id="expression"></div>

<div id="target"></div>
<div id="hint"></div>

<button onclick="checkAnswer()">CHECK</button>

<div id="message"></div>

<script>
const levels = { 1: 3, 2: 5, 3: 7 };
const OPS = ["+", "-", "*", "/"];

let currentLevel = 1;
let numbers = [];
let slots = [];
let hintSolutionOps = [];
let targetValue = 0;

let revealIndex = 0;
let revealTimer = null;

function startGame() {
    currentLevel = 1;
    startLevel();
}

function startLevel() {
    clearInterval(revealTimer);
    revealIndex = 0;

    document.getElementById("level").textContent = `Level ${currentLevel}`;
    document.getElementById("message").textContent = "";
    document.getElementById("hint").textContent = "";

    generatePuzzle();
    render();
    startRevealTimer();
}

function generatePuzzle() {
    const opsCount = levels[currentLevel];
    const numsCount = opsCount + 1;

    while (true) {
        numbers = [];
        for (let i = 0; i < numsCount; i++) {
            numbers.push(Math.floor(Math.random() * 9) + 1);
        }

        hintSolutionOps = [];

        for (let i = 0; i < opsCount; i++) {
            let op = OPS[Math.floor(Math.random() * 4)];

            if (op === "/") {
                let left = numbers[i];
                let divisors = [];
                for (let d = 1; d <= 9; d++) {
                    if (left % d === 0) divisors.push(d);
                }
                if (divisors.length === 0) {
                    op = OPS[Math.floor(Math.random() * 3)];
                } else {
                    numbers[i + 1] = divisors[Math.floor(Math.random() * divisors.length)];
                }
            }
            hintSolutionOps.push(op);
        }

        const result = evaluate(numbers, hintSolutionOps);
        if (Number.isInteger(result)) {
            targetValue = result;
            break;
        }
    }

    slots = Array(opsCount).fill(null);
}

function startRevealTimer() {
    revealTimer = setInterval(() => {
        if (revealIndex >= hintSolutionOps.length) {
            clearInterval(revealTimer);
            return;
        }
        slots[revealIndex] = hintSolutionOps[revealIndex];
        revealIndex++;
        document.getElementById("hint").textContent =
            `⏱ Hint revealed (${revealIndex}/${hintSolutionOps.length})`;
        render();
    }, 1000);
}

function render() {
    const expr = document.getElementById("expression");
    expr.innerHTML = "";

    numbers.forEach((num, i) => {
        expr.innerHTML += `<div>${num}</div>`;
        if (i < slots.length) {
            const cls = i < revealIndex ? "slot locked" : "slot";
            expr.innerHTML += `<div class="${cls}" onclick="cycleOp(${i})">${slots[i] ?? ""}</div>`;
        }
    });

    document.getElementById("target").textContent = `Target = ${targetValue}`;
}

function cycleOp(index) {
    if (index < revealIndex) return;
    if (slots[index] === null) {
        slots[index] = OPS[0];
    } else {
        slots[index] = OPS[(OPS.indexOf(slots[index]) + 1) % OPS.length];
    }
    render();
}

function checkAnswer() {
    if (slots.includes(null)) {
        document.getElementById("message").textContent = "⚠ Fill all operator slots";
        return;
    }

    const result = evaluate(numbers, slots);
    clearInterval(revealTimer);

    if (result === targetValue) {
        if (currentLevel < 3) {
            document.getElementById("message").textContent = "✅ Correct! Next level...";
            currentLevel++;
            setTimeout(startLevel, 1500);
        } else {
            setTimeout(() => {
                window.location.href = "congratulations.html";
            }, 1000);
        }
    } else {
        document.getElementById("message").textContent = "❌ Wrong! Resetting to Level 1";
        currentLevel = 1;
        setTimeout(startLevel, 1500);
    }
}

function evaluate(nums, ops) {
    let n = [...nums];
    let o = [...ops];

    let i = 0;
    while (i < o.length) {
        if (o[i] === "*") {
            n[i] *= n[i + 1];
            n.splice(i + 1, 1);
            o.splice(i, 1);
        } else if (o[i] === "/") {
            n[i] /= n[i + 1];
            n.splice(i + 1, 1);
            o.splice(i, 1);
        } else i++;
    }

    i = 0;
    while (i < o.length) {
        if (o[i] === "+") {
            n[i] += n[i + 1];
            n.splice(i + 1, 1);
            o.splice(i, 1);
        } else if (o[i] === "-") {
            n[i] -= n[i + 1];
            n.splice(i + 1, 1);
            o.splice(i, 1);
        }
    }
    return n[0];
}
</script>

</body>
</html>
