<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Knight's Tour Challenge</title>

    <style>
      body {
        background: #1e1e2f;
        color: #fff;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
      }

      h1 {
        color: #00ff99;
        margin-bottom: 10px;
      }

      #timer {
        font-size: 1.1em;
        margin-top: 5px;
        color: #ffcc00;
      }

      /* Responsive board */
      #board {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        width: min(90vw, 480px);
        aspect-ratio: 1 / 1;
        gap: 2px;
        margin-top: 20px;
      }

      .cell {
        width: 100%;
        aspect-ratio: 1 / 1;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 1.2em;
        cursor: pointer;
        transition: 0.2s;
      }

      .white {
        background-color: #f0d9b5;
      }
      .black {
        background-color: #b58863;
      }
      .visited {
        background-color: #00ff99 !important;
        color: #000;
      }
      .knight {
        color: #ff0000;
        font-size: 1.6em;
      }

      #message {
        margin-top: 20px;
        font-size: 1.2em;
        text-align: center;
      }

      button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 1em;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        background-color: #00ff99;
        color: #000;
        font-weight: bold;
        margin-right: 10px;
      }

      button:hover {
        background-color: #00cc77;
      }

      /* Congrats pop-up */
      #congrats {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #00ff99;
        color: #000;
        padding: 30px 40px;
        border-radius: 15px;
        font-size: 1.3em;
        text-align: center;
        display: none;
        box-shadow: 0 0 25px #00ff99;
        z-index: 1000;
      }

      #next-game-btn {
        margin-top: 15px;
        padding: 10px 20px;
        font-size: 1em;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        background-color: #ff9800;
      }

      #next-game-btn:hover {
        background-color: #e68900;
      }
    </style>
  </head>

  <body>
    <h1>Knight's Tour Challenge â™ž</h1>
    <div id="timer">Time: 10:00</div>
    <div id="board"></div>

    <p id="message">Click a starting square to place the knight.</p>

    <div>
      <button onclick="resetBoard()">Reset</button>
      <button onclick="undoMove()">Undo</button>
    </div>

    <div id="congrats"></div>
    <!-- Centered pop-up -->

    <script>
      const boardSize = 8;
      let board = [];
      let knightPos = null;
      let visitedCount = 0;
      let moveStack = [];
      let tourCompleted = false;

      /* Timer variables */
      let timerStarted = false;
      let timeLeft = 600; // 5 minutes
      let timerInterval = null;

      function createBoard() {
        const boardDiv = document.getElementById("board");
        boardDiv.innerHTML = "";

        board = [];
        visitedCount = 0;
        knightPos = null;
        moveStack = [];
        tourCompleted = false;

        stopTimer();
        timeLeft = 600;
        updateTimerDisplay();

        document.getElementById("message").textContent =
          "Click a starting square to place the knight.";

        for (let r = 0; r < boardSize; r++) {
          board[r] = [];
          for (let c = 0; c < boardSize; c++) {
            const cell = document.createElement("div");
            cell.classList.add("cell");
            cell.classList.add((r + c) % 2 === 0 ? "white" : "black");
            cell.dataset.row = r;
            cell.dataset.col = c;
            cell.addEventListener("click", () => handleMove(r, c, cell));
            boardDiv.appendChild(cell);
            board[r][c] = cell;
          }
        }

        // Hide pop-up if visible
        document.getElementById("congrats").style.display = "none";
      }

      function startTimer() {
        if (timerStarted) return;
        timerStarted = true;

        timerInterval = setInterval(() => {
          timeLeft--;
          updateTimerDisplay();
          if (timeLeft <= 0) {
            stopTimer();
            endGameByTimeout();
          }
        }, 1000);
      }

      function stopTimer() {
        timerStarted = false;
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      function updateTimerDisplay() {
        const minutes = String(Math.floor(timeLeft / 60)).padStart(2, "0");
        const seconds = String(timeLeft % 60).padStart(2, "0");
        document.getElementById("timer").textContent =
          `Time: ${minutes}:${seconds}`;
      }

      function endGameByTimeout() {
        tourCompleted = true;
        showCongrats(
          `â° Time's up!<br>You couldn't make it.<br>Moves made: ${visitedCount}`,
        );
      }

      /* Game logic */
      function handleMove(r, c, cell) {
        if (tourCompleted) return;

        if (!knightPos) {
          startTimer();
          knightPos = { r, c };
          cell.innerHTML = "â™ž";
          cell.classList.add("knight", "visited");
          visitedCount = 1;
          moveStack.push({ r, c });
          return;
        }

        const moves = [
          [2, 1],
          [1, 2],
          [-1, 2],
          [-2, 1],
          [-2, -1],
          [-1, -2],
          [1, -2],
          [2, -1],
        ];

        const isValid = moves.some(
          ([dr, dc]) => dr + knightPos.r === r && dc + knightPos.c === c,
        );
        if (!isValid || cell.classList.contains("visited")) {
          document.getElementById("message").textContent =
            "Invalid move! Try a legal knight move.";
          return;
        }

        board[knightPos.r][knightPos.c].innerHTML = "";
        board[knightPos.r][knightPos.c].classList.remove("knight");

        knightPos = { r, c };
        cell.innerHTML = "â™ž";
        cell.classList.add("knight", "visited");

        visitedCount++;
        moveStack.push({ r, c });

        if (visitedCount === boardSize * boardSize) {
          stopTimer();
          tourCompleted = true;
          showCongrats(
            `ðŸŽ‰ Congratulations! You completed the Knight's Tour!<br>Moves made: ${visitedCount}`,
          );
        } else {
          document.getElementById("message").textContent =
            `Moves made: ${visitedCount}`;
        }
      }

      function undoMove() {
        if (moveStack.length <= 1) {
          document.getElementById("message").textContent =
            "Cannot undo the first move.";
          return;
        }

        const current = moveStack.pop();
        board[current.r][current.c].innerHTML = "";
        board[current.r][current.c].classList.remove("knight", "visited");
        visitedCount--;

        const prev = moveStack[moveStack.length - 1];
        knightPos = { r: prev.r, c: prev.c };
        const prevCell = board[prev.r][prev.c];
        prevCell.innerHTML = "â™ž";
        prevCell.classList.add("knight");

        document.getElementById("message").textContent =
          `Move undone. Moves made: ${visitedCount}`;
      }

      function resetBoard() {
        createBoard();
      }

      function showCongrats(text) {
        const popup = document.getElementById("congrats");
        popup.innerHTML =
          text +
          `<br><button id="next-game-btn" onclick="goToNextGame()">Next Game â–¶</button>`;
        popup.style.display = "block";
      }

      function goToNextGame() {
        window.location.href = "math.html";
      }

      createBoard();
    </script>
  </body>
</html>
